<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet"
          integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
    <link rel="stylesheet" href="../static/style.css" th:href="@{/static/style.css}" type="text/css"/>
    <title>Admin page</title>
</head>
<body class="bg-light">
<nav class="navbar navbar-dark bg-dark" style="display: block; color: white">
    <div class="container-fluid">
        <span id="myUserDetails" class="navbar-brand ">
        </span>
        <form th:action="@{/logout}" method="post">
            <input type="submit" class="btn btn-link text-white-50" value="Logout"/>
        </form>
    </div>
</nav>

<div>
    <div class="block-left custom-col-left nav nav-pills flex-column back-white" id="v-pills-tab" role="tablist">
        <b class="nav-link active pill" id="v-pills-admin-tab" data-bs-toggle="pill"
           data-bs-target="#v-pills-admin" type="button" role="tab" aria-controls="v-pills-admin"
           aria-selected="true">Admin
        </b>
        <b class="nav-link pill" id="v-pills-user-tab" data-bs-toggle="pill"
           data-bs-target="#v-pills-user" type="button" role="tab" aria-controls="v-pills-user"
           aria-selected="false" onclick="loadUserTable()">User
        </b>
    </div>

    <div class="tab-content custom-tabs block-right section" id="v-pills-tabContent">

        <div class="tab-pane fade show active pillContent v-pills-admin-tab" id="v-pills-admin" role="tabpanel"
             aria-labelledby="v-pills-admin-tab" tabindex="0">
            <h2>Admin panel</h2>
            <ul class="nav nav-tabs" id="myTab" role="tablist">
                <li class="nav-item active" role="tab">
                    <button class="nav-link active taba" id="home-tab" data-bs-toggle="tab" data-bs-target="#home"
                            type="button" role="tab" aria-controls="home" aria-selected="true">
                        Users Table
                    </button>
                </li>
                <li class="nav-item" role="tab">
                    <button class="nav-link taba" id="profile-tab" data-bs-toggle="tab" data-bs-target="#profile"
                            type="button" role="tab" aria-controls="profile" aria-selected="false" onclick="newUser()"
                    >New User
                    </button>
                </li>
            </ul>

            <div class="tab-content" id="myTabContent">
                <div class="tab-pane fade show tabaContent home-tab active" id="home" role="tabpanel"
                     aria-labelledby="home-tab">
                    <div class="card" style="width: 100%;">
                        <div class="card-body">
                            <h5 class="card-header">All Users</h5>
                            <table class="table table-striped">
                                <thead>
                                <tr>
                                    <th scope="col">ID</th>
                                    <th scope="col">First Name</th>
                                    <th scope="col">Last Name</th>
                                    <th scope="col">Age</th>
                                    <th scope="col">Email</th>
                                    <th scope="col">Role</th>
                                    <th scope="col">Edit</th>
                                    <th scope="col">Delete</th>
                                </tr>
                                </thead>
                                <tbody id="tbody">

                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div class="tab-pane fade show border tabaContent profile-tab" id="profile" role="tabpanel"
                     aria-labelledby="profile-tab">
                    <div class="card" style="width: 100%;">
                        <h5 class="card-header">New user</h5>
                        <div class="card-body d-flex justify-content-center text-center">
                            <form id="formForNewUser">
                                <div class="form-group mt-4">
                                    <label for="name" class="col-form-label">First Name</label>
                                    <input id="name" type="text" class="form-control" name="name" placeholder="First name">
                                </div>
                                <div class="form-group">
                                    <label for="surname" class="col-form-label">Last Name</label>
                                    <input id="surname" type="text" class="form-control" name="surname" placeholder="Surname">
                                </div>
                                <div class="form-group mt-4">
                                    <label for="age" class="col-form-label">Age</label>
                                    <input id="age" type="text" class="form-control" name="age" placeholder="Age">
                                </div>
                                <div class="form-group mt-4">
                                    <label for="email" class="col-form-label">Email</label>
                                    <input id="email" type="email" class="form-control" name="email" placeholder="Email">
                                </div>
                                <div class="form-group mt-4">
                                    <label for="password">Password:</label>
                                    <div class="input-group">
                                        <input type="password" class="form-control" id="password" name="password" autocomplete="new-password" placeholder="Password"/>
                                    </div>
                                </div>
                                <div class="form-group mt-4">
                                    <label class="row font-weight-bold justify-content-center"
                                           for="roleSelect">Role</label>
                                    <select multiple class="form-control" size="2" id="roleSelect" name="roles">
                                        <option id="roleNewUser" value="1">USER</option>
                                        <option id="roleNewAdmin" value="2">ADMIN</option>
                                    </select>
                                </div>
                                <button type="submit" class="btn btn-success btn-lg mt-3" id="signup-submit"
                                        form="formForNewUser">Add new user
                                </button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="tab-pane fade show pillContent v-pills-user-tab" id="v-pills-user" role="tabpanel"
             aria-labelledby="v-pills-user-tab"
             tabindex="0">
            <h2>About User</h2>
            <div class="card" style="width: 100%;">
                <div class="card-body">
                    <table class="table table-striped">
                        <thead>
                        <tr>
                            <th scope="col">ID</th>
                            <th scope="col">First Name</th>
                            <th scope="col">Last Name</th>
                            <th scope="col">Age</th>
                            <th scope="col">Email</th>
                            <th scope="col">Role</th>
                        </tr>
                        </thead>
                        <tbody id="tableUser">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>


<div class="modal fade" id="editModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title">Edit user</h4>
            </div>
            <div class="modal-body text-center d-flex justify-content-center">
                <form id="formForEditing">
                    <label for="id_ed" class="col-form-label">Id</label>
                    <input id="id_ed" type="text" readonly="readonly" name="editedUserId" class="form-control">
                    <div class="form-group mt-4">
                        <label for="name_ed" class="col-form-label">First Name</label>
                        <input id="name_ed" type="text" class="form-control" name="name">
                    </div>
                    <div class="form-group mt-4">
                        <label for="surname_ed" class="col-form-label">Last Name</label>
                        <input id="surname_ed" type="text" class="form-control" name="surname">
                    </div>
                    <div class="form-group mt-4">
                        <label for="age_ed" class="col-form-label">Age</label>
                        <input id="age_ed" type="text" class="form-control" name="age">
                    </div>
                    <div class="form-group mt-4">
                        <label for="email_ed" class="col-form-label">Email</label>
                        <input id="email_ed" type="email" class="form-control" name="email">
                    </div>
                    <div class="form-group mt-4">
                        <label for="password_ed" class="col-form-label">Password</label>
                        <input id="password_ed" type="password" class="form-control" name="password">
                    </div>
                    <div>
                        <label class="mt-4" for="rolesForEditing">Role</label>
                        <select multiple class="form-control" size="2" id="rolesForEditing" name="roles">
                            <option id="roleUser" value="1">USER</option>
                            <option id="roleAdmin" value="2">ADMIN</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal" id="editCloseBtn">Close
                </button>
                <button type="button" class="btn btn-primary" id="editBtn" onclick="editUser(); getAdminPage()">
                    Edit
                </button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="exampleModalLabel">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title">Delete user</h4>
            </div>
            <div class="modal-body text-center d-flex justify-content-center">
                <form id="formForDeleting">
                    <label for="id_del" class="col-form-label">Id</label>
                    <input id="id_del" type="text" readonly="readonly" name="deletedUserId" class="form-control">
                    <div class="form-group mt-4">
                        <label for="name_del" class="col-form-label">First Name</label>
                        <input id="name_del" type="text" readonly="readonly" class="form-control" name="name">
                    </div>
                    <div class="form-group mt-4">
                        <label for="surname_del" class="col-form-label">Last Name</label>
                        <input id="surname_del" type="text" readonly="readonly" class="form-control" name="surname">
                    </div>
                    <div class="form-group mt-4">
                        <label for="age_del" class="col-form-label">Age</label>
                        <input id="age_del" type="text" readonly="readonly" class="form-control" name="age">
                    </div>
                    <div class="form-group mt-4">
                        <label for="email_del" class="col-form-label">Email</label>
                        <input id="email_del" type="email" readonly="readonly" class="form-control"
                               name="email">
                    </div>
                    <div class="form-group mt-4">
                        <label for="roles_del" class="col-form-label">Roles</label>
                        <select id="roles_del" multiple class="form-control" name="roles" disabled></select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal" id="deleteCloseBtn">Close
                </button>
                <button type="submit" class="btn btn-danger" id="deleteBtn" onclick="deleteUser(); getAdminPage()">
                    Delete
                </button>
            </div>
        </div>
    </div>
</div>



<script src="https://code.jquery.com/jquery-3.3.1.slim.min.js"
        integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo"
        crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/popper.js@1.14.7/dist/umd/popper.min.js"
        integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1"
        crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.3.1/dist/js/bootstrap.min.js"
        integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM"
        crossorigin="anonymous"></script>

<script>
    "use strict";

    const url = "http://localhost:8080/admin/users"

    async function getAdminPage() {
        let page = await fetch(url);
        if (page.ok) {
            let listAllUser = await page.json();
            loadTableData(listAllUser);
        } else {
            alert(`Error, ${page.status}`)
        }
    }

    const pills = document.querySelectorAll('.pill');
    const pillsContent = document.querySelectorAll('.pillContent');
    pills.forEach((clickedPill) => {
        clickedPill.addEventListener('click', async () => {
            pills.forEach((pill) => {
                pill.classList.remove('active');
            });
            clickedPill.classList.add('active');
            let tabId = clickedPill.getAttribute('id');
            await activePillContent(tabId);
        });
    });

    async function activePillContent(tabId) {
        pillsContent.forEach((clickedPillContent) => {
            clickedPillContent.classList.contains(tabId) ?
                clickedPillContent.classList.add('active') :
                clickedPillContent.classList.remove('active');
        })
    }

    async function getMyUser() {
        let res = await fetch('/api/auth');
        let resUser = await res.json();
        userNavbarDetails(resUser);
    }

    window.addEventListener('DOMContentLoaded', getMyUser);

    function userNavbarDetails(resUser) {
        let userList = document.getElementById('myUserDetails');
        let roles = ''
        for (let role of resUser.roles) {
            roles += role.name + ' '
        }
        userList.insertAdjacentHTML('beforeend', `
        <b> ${resUser.email} </b> with roles: <a>${roles} </a>`);
    }

    function loadTableData(listAllUser) {
        let tableBody = document.getElementById('tbody');
        let dataHtml = '';
        for (let user of listAllUser) {
            let roles = [];
            for (let role of user.roles) {
                roles.push(" " + role.name)
            }
            dataHtml +=
                `<tr>
    <td>${user.id}</td>
    <td>${user.name}</td>
    <td>${user.surname}</td>
    <td>${user.age}</td>
    <td>${user.email}</td>
    <td>${roles}</td>
    <td>
        <button class="btn blue-background" data-bs-toogle="modal"
        data-bs-target="#editModal"
        onclick="editModalData(${user.id})">Edit</button>
    </td>
        <td>
        <button class="btn btn-danger" data-bs-toogle="modal"
        data-bs-target="#deleteModal"
        onclick="deleteModalData(${user.id})">Delete</button>
    </td>
</tr>`
        }
        tableBody.innerHTML = dataHtml;
    }

    getAdminPage();

    </script>

<script>
    async function loadUserTable() {
        let tableBody = document.getElementById('tableUser');
        let page = await fetch("/api/auth");
        let currentUser;
        if (page.ok) {
            currentUser = await page.json();
        } else {
            alert(`Error, ${page.status}`)
        }
        let dataHtml = '';
        let roles = [];
        for (let role of currentUser.roles) {
            roles.push(" " + role.name)
        }
        dataHtml +=
            `<tr>
    <td>${currentUser.id}</td>
    <td>${currentUser.name}</td>
    <td>${currentUser.surname}</td>
    <td>${currentUser.age}</td>
    <td>${currentUser.email}</td>
    <td>${roles}</td>
</tr>`
        tableBody.innerHTML = dataHtml;
    }

    const tabs = document.querySelectorAll('.taba');
    const tabsContent = document.querySelectorAll('.tabaContent');
    tabs.forEach((clickedTab) => {
        clickedTab.addEventListener('click', async () => {
            tabs.forEach((tab) => {
                tab.classList.remove('active');
            });
            clickedTab.classList.add('active');
            let tabaId = clickedTab.getAttribute('id');
            await activeTabContent(tabaId);
        });
    });

    async function activeTabContent(tabaId) {
        tabsContent.forEach((clickedTabContent) => {
            clickedTabContent.classList.contains(tabaId) ?
                clickedTabContent.classList.add('active') :
                clickedTabContent.classList.remove('active');
        })
    }

    const form_new = document.getElementById('formForNewUser');

    async function newUser() {
        form_new.addEventListener('submit', addNewUser);
    }

    async function addNewUser(event) {
        event.preventDefault();
        let listOfRole = [];
        for (let i = 0; i < form_new.roleSelect.options.length; i++) {
            if (form_new.roleSelect.options[i].selected) {
                listOfRole.push({id: form_new.roleSelect.options[i].value,
                    role: form_new.roleSelect.options[i].text});
            }
        }
        let method = {
            method: 'POST',
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify({
                name: form_new.name.value,
                surname: form_new.surname.value,
                age: form_new.age.value,
                email: form_new.email.value,
                password: form_new.password.value,
                roles: listOfRole
            })
        }
        await fetch(url, method).then(() => {
            form_new.reset();
            getAdminPage();
            activeTabContent('home-tab');
            let activateTab = document.getElementById('home-tab');
            activateTab.classList.add('active');
            let deactivateTab = document.getElementById('profile-tab');
            deactivateTab.classList.remove('active');
        });
    }



    const form_ed = document.getElementById('formForEditing');
    const id_ed = document.getElementById('id_ed');
    const name_ed = document.getElementById('name_ed');
    const surname_ed = document.getElementById('surname_ed');
    const age_ed = document.getElementById('age_ed');
    const email_ed = document.getElementById('email_ed');
    const password_ed = document.getElementById('password_ed');


    async function editModalData(id) {
        $('#editModal').modal('show');
        const urlDataEd = 'http://localhost:8080/admin/users/' + id;
        let usersPageEd = await fetch(urlDataEd);
        if (usersPageEd.ok) {
            await usersPageEd.json().then(user => {
                id_ed.value = `${user.id}`;
                name_ed.value = `${user.name}`;
                surname_ed.value = `${user.surname}`;
                age_ed.value = `${user.age}`;
                email_ed.value = `${user.email}`;
                password_ed.value = `${user.password}`;
            })
        } else {
            alert(`Error, ${usersPageEd.status}`)
        }
    }

    async function editUser() {
        let urlEdit = 'http://localhost:8080/admin/users/' + id_ed.value;
        let listOfRole = [];
        for (let i = 0; i < form_ed.rolesForEditing.options.length; i++) {
            if (form_ed.rolesForEditing.options[i].selected) {
                listOfRole.push({
                    id: form_ed.rolesForEditing.options[i].value,
                    name: form_ed.rolesForEditing.options[i].text
                });
            }
        }

        if (listOfRole.length === 0) {
            const urlDataEd = 'http://localhost:8080/admin/users/' + id_ed.value;
            let usersPageEd = await fetch(urlDataEd);
            if (usersPageEd.ok) {
                let user = await usersPageEd.json();
                listOfRole = user.roles;
            } else {
                alert(`Ошибка, ${usersPageEd.status}`)
            }
        }

        let method = {
            method: 'PATCH',
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify({
                id: id_ed.value,
                name: name_ed.value,
                surname: surname_ed.value,
                age: age_ed.value,
                email: email_ed.value,
                password: password_ed.value,
                roles: listOfRole
            })
        }
        await fetch(urlEdit, method).then(() => {
            $('#editCloseBtn').click();
            getAdminPage();
        })
    }


    const form_del = document.getElementById('formForDeleting');
    const id_del = document.getElementById('id_del');
    const name_del = document.getElementById('name_del');
    const surname_del = document.getElementById('surname_del');
    const age_del = document.getElementById('age_del');
    const email_del = document.getElementById('email_del');
    const password_del = document.getElementById('password_del');

    async function deleteModalData(id) {
        $('#deleteModal').modal('show');
        const urlForDel = 'http://localhost:8080/admin/users/' + id;
        let usersPageDel = await fetch(urlForDel);
        if (usersPageDel.ok) {
            await usersPageDel.json().then(user => {
                id_del.value = `${user.id}`;
                name_del.value = `${user.name}`;
                surname_del.value = `${user.surname}`;
                age_del.value = `${user.age}`;
                email_del.value = `${user.email}`;

                const rolesSelect = document.getElementById('roles_del');
                rolesSelect.innerHTML = '';
                user.roles.forEach(role => {
                    const option = document.createElement('option');
                    option.value = role.id;
                    option.text = role.name;
                    rolesSelect.appendChild(option);
                });
            })
        } else {
            alert(`Error, ${usersPageDel.status}`)
        }
    }

    async function deleteUser() {
        let urlDel = 'http://localhost:8080/admin/users/' + id_del.value;
        let method = {
            method: 'DELETE',
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify({
                name: form_new.name.value,
                surname: form_new.surname.value,
                age: form_new.age.value,
                email: form_new.email.value,
            })
        }
        await fetch(urlDel, method).then(() => {
            $('#deleteCloseBtn').click();
            getAdminPage();
        })
    }

</script>


</body>
</html>

